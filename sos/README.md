# nest SOS - 緊急通知システム セットアップガイド

知的障害のある方がパニック時に**ボタン1つで助けを呼べる**システムです。

## 🎯 システム概要

```
📱 本人のスマホ          🖥️ 団体のPC            💬 グループLINE
┌─────────────┐        ┌─────────────┐        ┌─────────────┐
│ [SOSボタン]  │ ──────▶│  APIサーバー │ ──────▶│ 通知が届く   │
│             │  SOS   │  ・位置情報  │  LINE  │ ・誰が       │
│             │        │  ・本人情報  │        │ ・どこで     │
└─────────────┘        └─────────────┘        │ ・注意点    │
                              │               └─────────────┘
                              │
                       ┌──────┴──────┐
                       │   Neo4j     │
                       │ データベース │
                       └─────────────┘
```

## 📋 セットアップ手順

### Step 1: LINE公式アカウントの作成（15分）

1. **LINE Developersにアクセス**
   - https://developers.line.biz/

2. **ログイン**
   - 団体のLINEアカウントでログイン

3. **プロバイダー作成**
   - 「新規プロバイダー作成」をクリック
   - プロバイダー名: 団体名（例: 「〇〇福祉会」）

4. **Messaging APIチャネル作成**
   - 「新規チャネル作成」→「Messaging API」を選択
   - チャネル名: 「nest SOS」
   - チャネル説明: 「緊急通知用」
   - 業種: 「医療・福祉」

### Step 2: チャネルアクセストークンの取得

1. 作成したチャネルの設定画面を開く
2. 「Messaging API設定」タブをクリック
3. 「チャネルアクセストークン（長期）」の「発行」をクリック
4. **表示されたトークンをコピーして保存**

### Step 3: グループLINEに公式アカウントを招待

1. 通知を受けたいグループLINEを開く
2. 右上のメニュー → 「招待」
3. 作成した公式アカウント（nest SOS）を招待
4. グループに追加されたことを確認

### Step 4: グループIDを取得

**方法A: Webhook経由（推奨）**

1. LINE Developersの「Messaging API設定」
2. 「Webhook URL」に以下を設定:
   ```
   https://your-server.com/webhook
   ```
3. グループ内で公式アカウントに話しかける
4. サーバーのログからグループIDを確認

**方法B: Bot参加時のログ**

1. APIサーバーを起動した状態で
2. 公式アカウントをグループに招待
3. ログに表示されるグループIDをメモ

### Step 5: 設定ファイルの作成

1. `.env.example` を `.env` にコピー

```bash
cp .env.example .env
```

2. `.env` を編集

```env
# Neo4j接続情報（親亡き後支援DBと同じ）
NEO4J_URI=bolt://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=実際のパスワード

# LINE設定
LINE_CHANNEL_ACCESS_TOKEN=Step2で取得したトークン
LINE_GROUP_ID=Step4で取得したグループID
```

### Step 6: 依存パッケージのインストール

```bash
cd /path/to/neo4j-agno-agent
uv add fastapi uvicorn httpx
```

### Step 7: サーバー起動

```bash
cd sos
uv run python api_server.py
```

起動すると以下が表示されます:
```
==================================================
🆘 nest SOS API サーバー
==================================================
Neo4j: bolt://localhost:7687
LINE設定: ✅ 設定済み
==================================================
アプリURL: http://localhost:8000/app/?id=クライアント名
API URL: http://localhost:8000/api/sos
==================================================
```

## 📱 本人用アプリの設定

### QRコードの作成

各クライアント専用のURLを作成します:

```
http://サーバーのIPアドレス:8000/app/?id=山田健太
```

このURLをQRコードにして、本人のスマホで読み取らせます。

**QRコード作成サイト:**
- https://qr.quel.jp/
- https://www.cman.jp/QRcode/

### スマホへのインストール（PWA）

1. 上記URLをスマホのブラウザで開く
2. iPhoneの場合:
   - 「共有」→「ホーム画面に追加」
3. Androidの場合:
   - 「メニュー」→「ホーム画面に追加」

## 🔧 運用時の注意

### サーバーの常時起動

SOSを受信するには、PCを常時起動しておく必要があります。

**自動起動の設定（Windows）:**
1. スタートアップフォルダにバッチファイルを配置

**自動起動の設定（Mac）:**
1. 「システム環境設定」→「ユーザとグループ」→「ログイン項目」

### ネットワーク設定

- サーバーPCとスマホが同じネットワーク内にある必要があります
- 外部からアクセスする場合はポート開放が必要です

## 📊 通知メッセージの例

```
🆘【緊急SOS】

山田健太さんから助けを求めています！

⏰ 発信時刻: 2025/12/17 15:30

📍 現在地:
https://www.google.com/maps?q=33.8834,130.8752
（精度: 約15m）

📞 緊急連絡先:
　・山田花子（母）090-1234-5678
　・佐藤一郎（叔父）090-8765-4321

⚠️ 対応時の注意:
　🔴 後ろから急に声をかけない
　🟠 大きな音を立てない
```

## ❓ トラブルシューティング

### 「サーバーに接続できません」と表示される

- サーバーPCが起動しているか確認
- 同じWi-Fiに接続しているか確認
- ファイアウォールでポート8000が開いているか確認

### LINE通知が届かない

- LINE_CHANNEL_ACCESS_TOKENが正しいか確認
- LINE_GROUP_IDが正しいか確認
- 公式アカウントがグループに参加しているか確認

### 位置情報が取得できない

- スマホの位置情報設定がオンになっているか確認
- ブラウザに位置情報の許可を与えているか確認

## 📞 サポート

技術的な問題がある場合は、開発者にお問い合わせください。
